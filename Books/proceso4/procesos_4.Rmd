---
title: "Evaluación por procesos 4"
author: 
- Miguel Roca
- Rodrigo Huaman 
- Gerson Julca
- Fabrizzio Arce
- Jesus paucar
output: pdf_document
linkcolor : blue
header-includes:
   - \usepackage{amsmath}
   - \renewcommand{\and}{\\}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Carga de las bibliotecas
library(dplyr)
library(GGally)
library(gridExtra)

# Carga de los datos
dataRendimeinto <- read.csv(file = "export/dataRendimiento.csv")

# Selección de las variables de interés
df <- dataRendimeinto %>% 
  select(-c(1:7))

# Preparación de los datos
df <- df %>% 
  mutate(
    Plaguicidas = as.factor(Plaguicidas),
    Fertilizantes = as.factor(Fertilizantes),
    Credito = as.factor(Credito),
    Riego = as.factor(Riego),
    tamanoUA = as.factor(tamanoUA))

```

\tableofcontents

# 1. Análisis descriptivo de la variable dependiente y sus covariables.

## 1.1. Analizar la correlación entre cada par de variables cuantitativas
```{r warning=F, message=F, echo=F}
ggpairs(
  data = df %>% select(-c(Plaguicidas, Fertilizantes, Credito, Riego, 
                          tamanoUA)), 
  lower = list(continuous = "smooth"),
  diag = list(continuous = "barDiag"), 
  axisLabels = "none")
```

- La variable que tiene una mayor correlación con el rendimiento es la producción (r = 0.567).

- Gasto en maquinaria y Superficie sembrada están medianamente correlacionados (r = 0.787) por lo que posiblemente no sea útil introducir ambos predictores en el modelo.

- Gasto en insumos y Produccción están medianamente correlacionados (r = 0.709) por lo que posiblemente no sea útil introducir ambos predictores en el modelo.

- Gasto por Jornal y la Producción están medianamente correlacionados (r = 0.613) por lo que posiblemente no sea útil introducir ambos predictores en el modelo.

- Las variables Rendimiento y Cantidad de Jornaleros muestran una distribución exponencial, una transformación logarítmica posiblemente haría más normal su distribución.

## 1.2. Analizar las diferencias del valor promedio entre las categóricas 

```{r warning=F, message=F, echo=F}
p1 <- ggplot(data = df, 
       mapping=aes(x = Plaguicidas, y = Rendimiento, color=Plaguicidas)) +
  geom_boxplot() +
  geom_jitter(width = 0.1) +
  theme_bw() + theme(legend.position = "none")

p2 <- ggplot(data = df, 
       mapping=aes(x = Fertilizantes, y = Rendimiento, color=Fertilizantes)) +
  geom_boxplot() +
  geom_jitter(width = 0.1) +
  theme_bw() + theme(legend.position = "none")

p3 <- ggplot(data = df, 
       mapping=aes(x = Credito, y = Rendimiento, color=Credito)) +
  geom_boxplot() +
  geom_jitter(width = 0.1) +
  theme_bw() + theme(legend.position = "none")

p4 <- ggplot(data = df, 
       mapping=aes(x = Riego, y = Rendimiento, color=Riego)) +
  geom_boxplot() +
  geom_jitter(width = 0.1) +
  theme_bw() + theme(legend.position = "none")

p5 <- ggplot(data = df, 
       mapping=aes(x = tamanoUA, y = Rendimiento, color=tamanoUA)) +
  geom_boxplot() +
  geom_jitter(width = 0.1) +
  theme_bw() + theme(legend.position = "none")

grid.arrange(p1, p2, p3, p4, p5)

```

- La variable Plaguicidas parece no influir de forma significativa en el Rendimeinto

- La variable Fertilizantes parece influir de forma significativa en el Rendimeinto

- La variable Credito parece influir de forma significativa en el Rendimeinto

- La variable Riego no parece influir de forma significativa en el Rendimeinto

- La variable tamanoUA parece influir de forma significativa en el Rendimeinto

# 2. Análisis sobre su elección del mejor modelo econométrico y Análisis de sus pruebas de hipótesis
Hay diferentes formas para obtener el modelo más adecuado. Obtaremos por emplear el método mixto iniciando el modelo con todas las variables como predictores y realizando la selección de los mejores predictores con la medición Akaike(AIC).

## 2.1. Modelo completo
```{r warning=F, message=F, echo=F}
modelo <- lm(
  Rendimiento ~ Plaguicidas + Fertilizantes + GastoInsumos + Credito + Riego +
  sup_sembrada_ha + Produccion_t + tamanoUA + GastoJornal + CantJornaleros +
  JornalPC + GastoMaq,
  data = df )

summary(modelo)
```

- El modelo con todas las variables introducidas como predictores tiene un $R^2$ muy bajo (0.5014), es capaz de explicar el 50.14\% de la variabilidad observada en el rendimiento. 

## 2.2. Elección del mejor modelo
```{r warning=F, message=F}
step(object = modelo, direction = "both", trace = 1)
```

El mejor modelo resultante del proceso de selección ha sido:

```{r warning=F, message=F, echo=F}
modelo <- lm(
  formula = Rendimiento ~ GastoInsumos + Credito + Riego + sup_sembrada_ha + 
    Produccion_t + tamanoUA + GastoJornal + CantJornaleros + GastoMaq,
  data = df)

summary(modelo)
```

- Con la elección del mejor modelo el $R^2$ no mejoro significativamente (0.5022), ahora el modelo es capaz de explicar el 50.22\% de la variabilidad observada en el rendimiento. 

- El p-value del modelo es significativo (2.2e-16) por lo que se puede aceptar que el modelo no es por azar, al menos uno de los coeficientes parciales de regresión es distinto de 0.

- Por otro lado, al igual que en el modelo inicial tenemos coeficientes que no son significativos (Credito1, sup_sembrada_ha, tamanoUA2 y GastoJornal) lo que es un indicativo de que podrían no contribuir al modelo y probablemente sean retiradas.

$$
\begin{aligned} 
Rendimiento = 11.01 - 0.0015GastoInsumos + 9.004Credito1 + 14.27Riego1 + \\
0.94supSembradaHa + 0.01Produccion + 6.31tamanoUA2 + 10.99tamanoUA3 + \\
29.14tamanoUA4 + 47.64tamanoUA5 + 0.0002GastoJornal + 0.44CantJornaleros + \\
0.002GastoMaq
\end{aligned}
$$

- Por cada hectarea sembrada, el rendimeinto aumenta en promedio 0.94 unidades, manteniéndose constantes el resto de predictores.

- El rendimiento de las Unidades agropecurias de tamaño 5 son en promedio 47.64 veces más eficientes que el resto de unidades agropecuarias.

# 3. Análisis de los supuestos: Multicolinealidad, Heterocedasticidad, Normalidad de los residuos, valores influyentes.

## 3.1. Relación lineal entre los predictores numéricos y la variable respuesta

```{r warning=F, message=F, echo=F}
plot1 <- ggplot(data = df, aes(GastoInsumos, modelo$residuals)) +
  geom_point() + geom_smooth(color = "firebrick") + geom_hline(yintercept = 0) + theme_bw()

plot2 <- ggplot(data = df, aes(sup_sembrada_ha, modelo$residuals)) +
  geom_point() + geom_smooth(color = "firebrick") + geom_hline(yintercept = 0) + theme_bw()

plot3 <- ggplot(data = df, aes(Produccion_t, modelo$residuals)) +
  geom_point() + geom_smooth(color = "firebrick") + geom_hline(yintercept = 0) + theme_bw()

plot4 <- ggplot(data = df, aes(GastoJornal, modelo$residuals)) +
  geom_point() + geom_smooth(color = "firebrick") + geom_hline(yintercept = 0) + theme_bw()

plot5 <- ggplot(data = df, aes(CantJornaleros, modelo$residuals)) +
  geom_point() + geom_smooth(color = "firebrick") + geom_hline(yintercept = 0) + theme_bw()

plot6 <- ggplot(data = df, aes(GastoMaq, modelo$residuals)) +
  geom_point() + geom_smooth(color = "firebrick") + geom_hline(yintercept = 0) + theme_bw()

grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6)
```
No se aprecia una clara linealidad de las variables continuas con los residuos, esto puede ser por que se observan posibles datos atípicos los cuales pueden presentar influencia.

## 3.2. Distribución normal de los residuos
```{r warning=F, message=F, echo=F}
qqnorm(modelo$residuals)
qqline(modelo$residuals)

shapiro.test(modelo$residuals)
```

La condición de normalidad no se satisface, posiblemente debido a un dato atípico.

## 3.3. Variabilidad constante de los residuos (homocedasticidad)
```{r warning=F, message=F, echo=F}
ggplot(data = df, aes(modelo$fitted.values, modelo$residuals)) +
  geom_point() +
  geom_smooth(color = "firebrick", se = FALSE) +
  geom_hline(yintercept = 0) +
  theme_bw()
```

```{r warning=F, message=F, echo=F}
library(lmtest)
bptest(modelo)
```

Se evidencia la falta de homocedasticidad.

## 3.4. No Multicolinealidad
### Matriz de correlación entre predictores.
```{r warning=F, message=F, echo=F}
library(corrplot)
corrplot(cor(select(df, GastoInsumos, sup_sembrada_ha, Produccion_t, GastoJornal, CantJornaleros, GastoMaq)),
         method = "number", tl.col = "black")
```

Se puede apreciar una moderada correlación entre algunas variables.


## 3.5. Análisis de Inflación de Varianza (VIF):
```{r warning=F, message=F, echo=F}
library(car)
vif(modelo)
```

Hay predictores que muestran una correlación lineal muy alta e inflación de varianza, esto se puede deber a valores atípicos o datos influyentes.

## 3.6 Autocorrelación:

```{r warning=F, message=F, echo=F}
library(car)
dwt(modelo, alternative = "two.sided")
```
No hay evidencia de autocorrelación


# 4.Identificación de posibles valores atípicos o influyentes

```{r warning=F, message=F, echo=F}
library(dplyr)
library(dplyr)
df$studentized_residual <- rstudent(modelo)

ggplot(data = df, aes(x = predict(modelo), y = abs(studentized_residual))) +
  geom_hline(yintercept = 3, color = "grey", linetype = "dashed") +
  geom_point(aes(color = ifelse(abs(studentized_residual) > 3, 'red', 'black'))) +
  scale_color_identity() +
  labs(title = "Distribución de los residuos studentized",
       x = "predicción modelo") + 
  theme_bw() + theme(plot.title = element_text(hjust = 0.5))

which(abs(df$studentized_residual) > 3)
```

Se identifica varias observaciones atípicas.

```{r warning=F, message=F, echo=F}
ObsInfluyentes <- influence.measures(modelo)$infmat

ObsInfluyentes %>% 
  as.data.frame() %>% 
  select(cov.r, cook.d, hat) %>% 
  filter(cook.d > 1)

```

Según la Distancia Cook (cook.d): Se consideran influyentes valores superiores a 1. Por lo cual, se identifican datos influyentes.

## La visualización gráfica de las influencias se obtiene del siguiente modo:
  
```{r warning=F, message=F, echo=F}
influencePlot(modelo)
```

Los análisis muestran varias observaciones influyentes (posición 375 y 1007) que exceden los límites de preocupación para los valores de Leverages o Distancia Cook. Se recomienda realizar el análisis quitando estos datos atípicos.

# Análisis de estabilidad de parámetros.
```{r warning=F, message=F, echo=F}
library(strucchange)

sctest(
  df$Rendimiento ~ df$GastoInsumos + df$Credito + df$Riego + df$sup_sembrada_ha 
  + df$Produccion_t + df$tamanoUA + df$GastoJornal + df$CantJornaleros + 
    df$GastoMaq, type = "Chow")
```
Se puede concluir que no existe estabilidad paramétrica entre el Rendimiento y sus covariables.
       
# 5.Conclusión
- El modelo es capaz de explicar tan solo 50.22% de la variabilidad observada en el rendimiento, por lo que no es muy bueno para predecir el rendimiento. 

- El test F muestra que es significativo (p-value: 2.2e-16).

- Se encontraron variables que no son significativas como (Credito1, sup_sembrada_ha, tamanoUA2 y GastoJornal).

- No se satisfacen los supuestos de la regresión. 

- Se encontro dos observaciones (posición 375 y 1007) podrían estar influyendo de forma notable en el modelo.